<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Consensus Hand Signals</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js"
            integrity="sha512-2AL/VEauKkZqQU9BHgnv48OhXcJPx9vdzxN1JrKDVc4FPU/MEE/BZ6d9l0mP7VmvLsjtYwqiYQpDskK9dG8KBA=="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js"
            integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA=="
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        * {font-family: 'Fira Code', monospace;}
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            color: #6d6875;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="form">
    <label for="username">Username:</label> <input type="text" name="username" id="username"> <span onclick="clearMe()">Ã—</span>
    <br>
    <button onclick="sendMood('agree')">Agree</button>
    <button onclick="sendMood('agree and volunteer')">Agree and volunteer</button>
    <button onclick="sendMood('response')">Response</button>
    <button onclick="sendMood('direct response')">Direct Response</button>
    <button onclick="sendMood('technical point')">Technical Point</button>
    <button onclick="sendMood('language')">Language</button>
    <button onclick="sendMood('speak up')">Speak Up</button>
    <button onclick="sendMood('slow down')">Speak Up</button>
    <button onclick="sendMood('I\'m confused')">I'm Confused</button>
    <button onclick="sendMood('veto')">Veto</button>
</div>
<div class="mood-list" data-bind="foreach: moods">
    <article class="mood" data-bind="click: $root.removeMood"><span data-bind="text: username"></span> :: <span
            data-bind="text: mood"></span></article>
</div>
<div class="footer">
    <p>{{.}}</p>
</div>
<script type="application/javascript">
    try {
        document.getElementById("username").value = document.cookie.split("; ").find(row => row.startsWith("username=")).split('=')[1]
    } catch (e) {
        console.log("New user")
    }

    const MoodViewModel = {
        moods: ko.observableArray([])
    }
    MoodViewModel.removeMood = function () {
        fetch("/delete", {
            method: "post",
            body: JSON.stringify({username: this.username, mood: this.mood})
        })
        MoodViewModel.moods.remove(this);
    }
    ko.applyBindings(MoodViewModel);

    function resetMoods() {
        MoodViewModel.moods.removeAll()
        fetch("/all")
            .then(res => res.json())
            .then((all) => {
                if (all != null) {
                    all.forEach(mood => {
                        MoodViewModel.moods.push(mood)
                    })
                }
            })
    }

    function clearMe() {
        fetch("/delete", {
            method: 'post',
            body: JSON.stringify({
                username: document.getElementById("username").value,
                mood: ""
            })
        })
    }

    function sendMood(mood) {
        const username = document.getElementById("username").value
        document.cookie = `username=${username};SameSite=Strict`;
        fetch("/mood", {
            method: 'post',
            body: JSON.stringify({username: username, mood: mood})
        })
    }

    // Get relative path to websocket
    let loc = window.location, new_uri;
    if (loc.protocol === "https:") {
        new_uri = "wss:";
    } else {
        new_uri = "ws:";
    }
    new_uri += "//" + loc.host;
    new_uri += loc.pathname + "ws";

    const moodSocket = new ReconnectingWebSocket(new_uri);
    const update = function () {
        moodSocket.onopen = function () {
            console.log("(re)-connected")
            resetMoods()
        }
        moodSocket.onmessage = function (event) {
            const moodOperation = JSON.parse(event.data)
            const mood = {username: moodOperation.username, mood: moodOperation.mood}
            switch (moodOperation.operation) {
                case "Delete":
                    MoodViewModel.moods.remove(function (item) {
                        return item.username === mood.username
                    });
                    break;
                case "Save":
                    MoodViewModel.moods.remove(function (item) {
                        return item.username === mood.username
                    });
                    MoodViewModel.moods.push(mood)
            }
        }
    };
    window.setTimeout(update);
</script>
</body>
</html>